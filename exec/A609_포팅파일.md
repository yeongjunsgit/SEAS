
# ê°œë°œ í™˜ê²½

## 1. Stacks

### Backend Application

- Java : openjdk-17
- Spring boot : 3.2.2
    - tomcat : 10.1.18, ë‚´ì¥ í†°ìº£
    - gradle : 8.5
    - Spring security : 6.2.1
- docker : 24.0.5
- MySQL : 8.3
- flyway : 9.22.3
- IntelliJ : 2021.2.4

### Frontend Application

- vue : 3.3.11
- vuetify : 5.0.10
- pinia : 2.1.7
- d3 : 7.8.5
- sass : 1.70.0
- chart.js : 4.4.1
- gsap : 3.12.5

## 2. Build & Distribute

- Jenkins : 2.441
- nginx : 1.18.0
- docker : 24.0.5

## 3. í”„ë¡œê·¸ë¨ ì‹¤í–‰

### ë°±ì—”ë“œ ì‹¤í–‰ ë°©ë²•

1. docker í´ë”(S10P12A609\docker)ë¡œ ì´ë™
2. ì•„ë˜ì˜ ëª…ë ¹ì–´ ì‹¤í–‰

```java
docker-compose up -d
```

1. seas-be í´ë” (S10P12A609\seas-be)ë¡œ ì´ë™
2. ì•„ë˜ì˜ ëª…ë ¹ì–´ë¡œ ì‹¤í–‰

```java
./gradlew bootrun
```

### í”„ë¡ íŠ¸ì—”ë“œ ì‹¤í–‰ ë°©ë²•

1. seas-feë¡œ ì´ë™ í›„ vscode ì‹¤í–‰
2. bashì—ì„œ ì•„ë˜ì˜ ëª…ë ¹ì–´ ì‹¤í–‰

```bash
npm i
```

- ìœ„ ëª…ë ¹ì–´ë¡œ ì¸í•´ package.jsonì— ìˆëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ê·¸ëŒ€ë¡œ ë°›ìŒ
1. bashì— ì•„ë˜ì˜ ëª…ë ¹ì–´ ì‹¤í–‰

```bash
npm run dev 
```

- ìœ„ ëª…ë ¹ì–´ë¡œ localhostë¡œ ì‚¬ì´íŠ¸ ì‹¤í–‰

## 4. ì¸í”„ë¼ í™˜ê²½ ì„¤ì •í•˜ê¸°

### EC2ì—ì„œ docker ì„¤ì¹˜

```java
sudo apt-get install docker
```

### EC2ì—ì„œ Jenkins docker build & run

```java
docker pull jenkins
sudo docker exec -p 9090:8080 -v /var/run/docker.sock:/var/run/docker.sock --name jenkins <jenkins_image_name>
```

### Jenkins ì ‘ì† ë°©ë²•

```java
jenkins ì‹¤í–‰ í›„ ì½˜ì†”ì—ì„œ ë‚˜ì˜¤ëŠ” ì„ì‹œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥, ì´í›„ ì  í‚¨ìŠ¤ ìœ ì € ì •ë³´ë¥¼ ì„¤ì •í•œ í›„ ì  í‚¨ìŠ¤ë¥¼ ì„¤ì •í•  ìˆ˜ ìˆë‹¤.
```

## 4. Jenkins í”ŒëŸ¬ê·¸ì¸ ì„¤ì¹˜ ë° íŒŒì´í”„ë¼ì¸ ì‘ì„±

### í”ŒëŸ¬ê·¸ì¸ ì„¤ì¹˜


- Jenkins ê´€ë¦¬ â†’ Pluginì—ì„œ ì„¤ì¹˜ ê°€ëŠ¥
- Plugin ì„¤ì •ì€ Jenkins ê´€ë¦¬ â†’ Toolsì—ì„œ ì„¤ì • ê°€ëŠ¥

<aside>
ğŸ’¡ Toolsì—ì„œ ì„¤ì •í•œ pluginì˜ IDì˜ ê²½ìš° ì¶”í›„ íŒŒì´í”„ë¼ì¸ ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ì‚¬ìš©í•˜ê²Œ ëœë‹¤.
ì•„ë˜ì˜ ì½”ë“œë¥¼ ì°¸ê³ 

</aside>

```java
pipeline{
    agent any
    
    tools {
				// pluginìœ¼ë¡œ nodeë¥¼ ì„¤ì¹˜í•˜ê³ , toolsì—ì„œ idë¥¼ jenkins-nodejsë¡œ ì„¤ì •
        nodejs 'jenkins-nodejs'
    }    
}
```

### íŒŒì´í”„ë¼ì¸ ìŠ¤í¬ë¦½íŠ¸

- Jenkins ìƒˆë¡œìš´ ITEM ì‘ì„± â†’ íŒŒì´í”„ë¼ì¸ (free Projectë„ ë¬´ë°©) ì„ ìƒì„±í•  ìˆ˜ ìˆìŒ

### í”„ë¡ íŠ¸(Vue) íŒŒì´í”„ë¼ì¸

```java
pipeline{
    agent any
    
    tools {
        nodejs 'jenkins-nodejs'
        dockerTool 'jenkins-docker'
    }
    
    stages{
        stage('git clone-FE'){
			steps{
				git branch: 'frontend',
				credentialsId : '4d40fefc-0c8d-4a17-86da-da3f0b7acb43',
				url : 'https://lab.ssafy.com/s10-webmobile2-sub2/S10P12A609.git'
			}
		}
		stage('FE-build'){
			steps{
				dir("./docker"){
					sh "docker build -t seas-vue -f ./dockerfile/vue.dockerfile ../"
				}
			}
		}
		stage('FE-docker'){
			steps{
			    sh "docker rm -f seas-vue"
				sh "docker run --name seas-vue -p 5173:80 -d seas-vue"
			}
		}
    }
    
}
```

### ë°±ì—”ë“œ(Spring boot) íŒŒì´í”„ë¼ì¸

```java
pipeline{
    agent any
    
    tools {
        // Jenkinsì—ì„œ ë“±ë¡í•œ Node.js ë„êµ¬ì˜ ì´ë¦„ì„ ì‚¬ìš©í•˜ì—¬ ìë™ìœ¼ë¡œ ì„¤ì¹˜
        gradle 'jenkins-gradle'
        dockerTool 'jenkins-docker'
    }
    
    stages{
        stage('git clone-BE'){
			steps{
				git branch: 'backend',
				credentialsId : '4d40fefc-0c8d-4a17-86da-da3f0b7acb43',
				url : 'https://lab.ssafy.com/s10-webmobile2-sub2/S10P12A609'
			}
		}
        stage('BE-SPRING-CONFIG'){
            steps{
                dir('./'){
                    withCredentials([file(credentialsId: 'seas-config', variable: 'config')]) {
                        sh 'mv ${config} /var/jenkins_home/workspace/seas-back/seas-be/src/main/resources'
                    }
                }
            }
        }
		stage('BE-spring-boot-clean'){
			steps{
                dir("./seas-be"){
				    sh "chmod +x gradlew"
				    sh "./gradlew clean"
				    
				}
			}
		}
		stage('BE-spring-boot-build'){
			steps{
                dir("./seas-be"){
				    
				    sh "./gradlew build -x test --stacktrace"
				}
			}
		}
		stage('BE-docker-image-build'){
			steps{
			    dir("./docker"){
			        sh 'pwd'
                    sh "docker build -t seas-spring -f ./dockerfile/spring.dockerfile ../"
			    }
			}
		}
		stage('BE-docker-container-prune'){
			steps{
			    sh "docker container prune"
			}
		}
		stage('BE-spring-container'){
			steps{
			    dir("."){
			        script{
    			        
            			def containerName = 'seas-spring'
    
                        // ë„ì»¤ ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸ ëª…ë ¹ì–´
                        def containerStatus = sh(script: "docker container inspect -f '{{.State.Running}}' $containerName", returnStatus: true)
                        echo "$containerStatus"
                        
                        if (containerStatus == 0) {
                            echo "ë„ì»¤ ì»¨í…Œì´ë„ˆ $containerName ê°€ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤."
                            
                            sh "docker rm -f seas-spring"
                        } 
                        
                        echo "ë„ì»¤ ì»¨í…Œì´ë„ˆ $containerName ê°€ ì‹¤í–‰ë˜ê³  ìˆì§€ ì•ŠìŠµë‹ˆë‹¤."
                        sh "docker run --name seas-spring --hostname seas-spring --net backend -p 2890:8080 -d seas-spring"
                    
    			    }
			    }
			}
		}
    }
}
```

### DB(MySQL) íŒŒì´í”„ë¼ì¸

```java
pipeline{
    agent any
    
    tools {
        // Jenkinsì—ì„œ ë“±ë¡í•œ Node.js ë„êµ¬ì˜ ì´ë¦„ì„ ì‚¬ìš©í•˜ì—¬ ìë™ìœ¼ë¡œ ì„¤ì¹˜
        gradle 'jenkins-gradle'
        dockerTool 'jenkins-docker'
    }
    
    stages{
        stage('git clone-BE'){
			steps{
				git branch: 'backend',
				credentialsId : '4d40fefc-0c8d-4a17-86da-da3f0b7acb43',
				url : 'https://lab.ssafy.com/s10-webmobile2-sub2/S10P12A609'
			}
		}
        stage('BE-SPRING-CONFIG'){
            steps{
                dir('./'){
                    withCredentials([file(credentialsId: 'seas-config', variable: 'config')]) {
                        sh 'mv ${config} /var/jenkins_home/workspace/seas-back/seas-be/src/main/resources'
                    }
                }
            }
        }
		stage('BE-spring-boot-clean'){
			steps{
                dir("./seas-be"){
				    sh "chmod +x gradlew"
				    sh "./gradlew clean"
				    
				}
			}
		}
		stage('BE-spring-boot-build'){
			steps{
            dir("./seas-be"){
				    
				    sh "./gradlew build -x test --stacktrace"
				}
			}
		}
		stage('BE-docker-image-build'){
			steps{
			    dir("./docker"){
			        sh 'pwd'
                    sh "docker build -t seas-spring -f ./dockerfile/spring.dockerfile ../"
			    }
			}
		}
		stage('BE-docker-container-prune'){
			steps{
			    sh "docker container prune"
			}
		}
		stage('BE-spring-container'){
			steps{
			    dir("."){
			        script{ 			        
            			def containerName = 'seas-spring'
   
                  // ë„ì»¤ ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸ ëª…ë ¹ì–´
                  def containerStatus = sh(script: "docker container inspect -f '{{.State.Running}}' $containerName", returnStatus: true)
                  echo "$containerStatus"
                  
                  if (containerStatus == 0) {
                      echo "ë„ì»¤ ì»¨í…Œì´ë„ˆ $containerName ê°€ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤."
                      
                      sh "docker rm -f seas-spring"
                  } 
                  
                  echo "ë„ì»¤ ì»¨í…Œì´ë„ˆ $containerName ê°€ ì‹¤í–‰ë˜ê³  ìˆì§€ ì•ŠìŠµë‹ˆë‹¤."
                  sh "docker run --name seas-spring --hostname seas-spring --net backend -p 2890:8080 -d seas-spring"
              
    			    }
			    }
			}
		}
    }
}
```

### Redis íŒŒì´í”„ë¼ì¸

```java
pipeline{
    agent any
    
    tools {
        // Jenkinsì—ì„œ ë“±ë¡í•œ Node.js ë„êµ¬ì˜ ì´ë¦„ì„ ì‚¬ìš©í•˜ì—¬ ìë™ìœ¼ë¡œ ì„¤ì¹˜
        gradle 'jenkins-gradle'
        dockerTool 'jenkins-docker'
    }
    
    stages{
	    stage('git clone-BE'){
				steps{
					git branch: 'backend',
					credentialsId : '4d40fefc-0c8d-4a17-86da-da3f0b7acb43',
					url : 'https://lab.ssafy.com/s10-webmobile2-sub2/S10P12A609'
				}
			}
			stage('BE-docker-network'){
			    steps{ 
			        sh "docker network create backend --gateway 172.18.0.1 || true"
			    }
			}
			stage('BE-redis-image-build'){
				steps{
				    dir("./docker"){
				        sh 'pwd'
	                    sh "docker build -t seas-redis -f ./dockerfile/redis.dockerfile ../"
				    }
				}
			}
			stage('BE-docker-container-prune'){
				steps{
				    sh "docker container prune"
				}
			}
			stage('BE-redis-container'){
				steps{
				    dir("."){
				        script{
	            			def containerName = 'seas-redis'
	
	                  // ë„ì»¤ ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸ ëª…ë ¹ì–´
	                  def containerStatus = sh(script: "docker container inspect -f '{{.State.Running}}' $containerName", returnStatus: true)
	                  echo "$containerStatus"
	                  
	                  if (containerStatus == 0) {
	                      echo "ë„ì»¤ ì»¨í…Œì´ë„ˆ $containerName ê°€ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤."
	                      sh "docker rm -f seas-mysql"
	                  }
	                  
	                  echo "ë„ì»¤ ì»¨í…Œì´ë„ˆ $containerName ê°€ ì‹¤í–‰ë˜ê³  ìˆì§€ ì•ŠìŠµë‹ˆë‹¤."
	                  sh "docker run --name seas-redis -p 6379:6379 --net backend -d seas-redis"
	    			    }
				    }
		    }
    }
}
```

<aside>
ğŸ’¡ ë„ì»¤ì—ì„œì˜ ì»¨í…Œì´ë„ˆë¼ë¦¬ í†µì‹ í•˜ê¸° ìœ„í•´ì„œëŠ” ê°™ì€ ë„¤íŠ¸ì›Œí¬ì— ì†Œì†ë˜ì–´ ìˆì–´ì•¼ í•˜ë¯€ë¡œ,
ë°±ì—”ë“œ ì»¨í…Œì´ë„ˆ(Spring boot, MySQL, Redis)ì˜ ê²½ìš° ë„ì»¤ ë‚´ë¶€ì—ì„œ â€˜backendâ€™ networkë¥¼
ìƒì„±í•˜ì—¬ ë¬¶ì–´ì¤€ë‹¤.

í•´ë‹¹ ì»¨í…Œì´ë„ˆë“¤ì€ ì»¨í…Œì´ë„ˆ ì´ë¦„(docker run ì‹œ â€”nameìœ¼ë¡œ ëª…ëª…í•œ ì´ë¦„)ìœ¼ë¡œ í†µì‹ í•œë‹¤.

</aside>

## í™˜ê²½ ë³€ìˆ˜ íŒŒì¼

### Backend Infra

```java
infra package

docker
|
|-- dockerfile
|		-- spring, vue, redis, mysql dockerfile ì¡´ì¬
|-- nginx
|		-- nginx.conf íŒŒì¼ ì¡´ì¬, vue ë„ì»¤ íŒŒì¼ì—ì„œ ì‚¬ìš©ë¨
|
|-- .env 
|-- docker-compose.yml

```

- .env
    - DB ì •ë³´ ì…ë ¥

```java
MYSQL_ROOT_PASSWORD=<ROOT ë¹„ë°€ë²ˆí˜¸ ì„¤ì •>
MYSQL_USER=<DB ìœ ì € ì´ë¦„ ì„¤ì •>
MYSQL_PASSWORD=<DB ìœ ì € ë¹„ë°€ë²ˆí˜¸ ì„¤ì •>
```

- init.sql
    - DB ì‹¤í–‰ ì‹œ ê°€ì¥ ë¨¼ì € ì‹¤í–‰ë˜ëŠ” sql íŒŒì¼

```java
DROP DATABASE IF EXISTS <DB ì´ë¦„>;
CREATE DATABASE <DB ì´ë¦„>;
```

- docker-compose.yml
    - ì—¬ëŸ¬ ì»¨í…Œì´ë„ˆë¥¼ í•œ ë²ˆì— ì˜¬ë¦¬ê¸° ìœ„í•´ ì‚¬ìš©í•˜ëŠ” íŒŒì¼
    - redis, mysqlì´ í•´ë‹¹ íŒŒì¼ì— ê¸°ìˆ ë˜ì–´ ìˆìŒ

```java
services:
  seas-redis:
    image: redis
    ports:
      - 6379:6379
    build:
      context: ../
    networks:
      - backend

  seas-mysql:
    build:
      context: ../
      dockerfile: "./docker/dockerfile/mysql.dockerfile"
    env_file: ".env"
    ports:
      - 3306:3306
    networks:
      - backend

networks:
  backend:
    external: true
```

### backend application

- /src/main/resourcesì— ëª¨ë‘ ìœ„ì¹˜
- application.yml
    - ì–´í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰ ì •ë³´ë¥¼ ë‹´ëŠ” íŒŒì¼

```java
spring:
  profiles:
    active: prod
  datasource:
    driver-class-name: <DB driver>
    url: jdbc:mysql://${DB_HOST}:${DB_PORT}/${DB_NAME}?serverTimezone=UTC&useUnicode=true&characterEncoding=utf8&useSSL=false&allowPublicKeyRetrieval=true
    username: ${DB_USERNAME}
    password: ${DB_PASSWORD}
  jpa:
    hibernate:
      ddl-auto: none
    show-sql: true
    properties:
      hibernate:
        format_sql: true
        show_sql: true

  flyway:
    enabled: true

  redis:
    data:
      host: <ë ˆë””ìŠ¤ host>
      port: 6379

springdoc:

  swagger-ui:
    # config-url: /v3/api-docs/swagger-config
    path: /swagger
    url: /v3/api-docs
    operations-sorter: method
  api-docs:
    enabled: true
    path: /v3/api-docs

server:
  # forward-headers-strategy: framework
  port: 8080
  servlet:
    context-path: /api

logging:
  level:
    root: INFO
  discord:
    webhook-url: ${DISCORD_WEBHOOK_URL}
  config: classpath:logback-spring.xml

secretKeyPlain: ${KEY}
```

- seas-config.yml
    - application í™˜ê²½ë³€ìˆ˜ì˜ ì‹¤ì œ ê°’ì„ ë‹´ê³  ìˆëŠ” íŒŒì¼

```java
DB_DRIVER: <ì‚¬ìš©í•˜ëŠ” DB Driver>
DB_HOST: <DB í˜¸ìŠ¤íŠ¸>
DB_PORT: <DB í¬íŠ¸>
DB_NAME: <DB ë°ì´í„°ë² ì´ìŠ¤>
DB_USERNAME: <ì ‘ì† ìœ ì €>
DB_PASSWORD: <ìœ ì € ë¹„ë°€ë²ˆí˜¸>
// token Key
KEY: <Token Key>
// ë””ìŠ¤ì½”ë“œ ë¡œê¹…ìš© ì£¼ì†Œ
DISCORD_WEBHOOK_URL: <discord ë¡œê¹…ìš© ì£¼ì†Œ>
```

- logback-spring.xml
    - ì„œë²„ ë¡œê¹…ìš©ìœ¼ë¡œ ì„¤ì •í•´ë†“ì€ íŒŒì¼ì…ë‹ˆë‹¤.

```java
<?xml version="1.0" encoding="UTF-8"?>
<configuration>
    <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
        <encoder>
            <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] [traceId=%X{traceId}] %-5level %logger{36}.%M - %msg%n
            </pattern>
        </encoder>
    </appender>
    <springProfile name="(dev | prod)">
        <root level="info">
            <appender-ref ref="CONSOLE"/>
        </root>
    </springProfile>
</configuration>
```

## ì™¸ë¶€ ì„œë¹„ìŠ¤ ì •ë³´

### S3(í”„ë¡ íŠ¸ ì´ë¯¸ì§€ ì €ì¥)

- https://aws.amazon.com/ko/s3/?nc2=type_a

### CloudFront(ìºì‹±ì„ ìœ„í•œ ì—£ì§€ ì„œë²„)

- https://aws.amazon.com/ko/cloudfront/?nc2=type_a

## DB ë¤í”„ íŒŒì¼

## ì‹œì—° ì‹œë‚˜ë¦¬ì˜¤
